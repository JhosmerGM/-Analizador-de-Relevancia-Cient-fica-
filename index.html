<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analizador de Relevancia Cient√≠fica - IA y Chatbots</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .custom-shadow {
        box-shadow:
          0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }

      /* Ajustes para la grilla y truncado de texto */
      .truncate-multiline {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        overflow: hidden;
        white-space: normal; /* Permite el salto de l√≠nea */
        word-wrap: break-word; /* Rompe palabras largas si es necesario */
      }
      .truncate-abstract {
        -webkit-line-clamp: 4;
      } /* Muestra hasta 4 l√≠neas del resumen */
      .truncate-title {
        -webkit-line-clamp: 3;
      } /* Muestra hasta 3 l√≠neas del t√≠tulo */
      .truncate-keywords {
        -webkit-line-clamp: 2;
      } /* Muestra hasta 2 l√≠neas de palabras clave */

      /* Forzar anchos de tabla para respetar la grilla */
      table {
        table-layout: fixed;
        width: 100%;
      }
      /* Ajustar anchos espec√≠ficos de columnas */
      .col-rank {
        width: 4%;
      }
      .col-score {
        width: 6%;
      }
      .col-authors {
        width: 10%;
      }
      .col-title {
        width: 15%;
      }
      .col-year {
        width: 4%;
      }
      .col-journal {
        width: 10%;
      }
      .col-abstract {
        width: 25%;
      } /* Mayor espacio para el resumen */
      .col-keywords {
        width: 12%;
      }
      .col-lang {
        width: 5%;
      }
      .col-type {
        width: 5%;
      }
      .col-links {
        width: 4%;
      }

      td {
        vertical-align: top;
      } /* Alinea el texto de las celdas arriba */
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen">
    <div class="max-w-[1600px] mx-auto px-4 py-10">
      <!-- Aument√© el max-w para aprovechar pantallas grandes -->
      <!-- Encabezado -->
      <div
        class="bg-white rounded-2xl p-8 mb-8 custom-shadow border border-slate-100"
      >
        <h1 class="text-3xl font-bold text-slate-800 mb-6">
          Analizador de Relevancia Cient√≠fica
        </h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-slate-700"
              >Subir archivo (Soporta Scopus y Web of Science)</label
            >
            <input
              type="file"
              id="csvFile"
              accept=".csv, .xlsx, .xls"
              class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
            />
          </div>
          <div class="flex gap-3">
            <button
              onclick="processData()"
              class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-xl transition-all shadow-lg shadow-blue-200"
            >
              Analizar y Ordenar
            </button>
            <button
              id="downloadBtn"
              onclick="downloadResult()"
              class="hidden bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2.5 px-6 rounded-xl transition-all shadow-lg shadow-emerald-200"
            >
              Descargar Excel
            </button>
          </div>
        </div>
      </div>

      <!-- Estad√≠sticas R√°pidas -->
      <div
        id="statsContainer"
        class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"
      >
        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
          <p class="text-sm text-slate-500 uppercase tracking-wider font-bold">
            Total Procesados
          </p>
          <p id="totalCount" class="text-3xl font-bold text-slate-800">0</p>
        </div>
        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
          <p class="text-sm text-slate-500 uppercase tracking-wider font-bold">
            Alta Relevancia
          </p>
          <p id="highRelCount" class="text-3xl font-bold text-emerald-600">0</p>
        </div>
        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
          <p class="text-sm text-slate-500 uppercase tracking-wider font-bold">
            Rango 2021-2025
          </p>
          <p id="yearMatchCount" class="text-3xl font-bold text-blue-600">0</p>
        </div>
      </div>

      <!-- Tabla de Resultados en Pantalla -->
      <div
        class="bg-white rounded-2xl overflow-hidden custom-shadow border border-slate-100"
      >
        <div class="overflow-x-auto">
          <table
            id="resultTable"
            class="w-full text-left border-collapse min-w-[1200px]"
          >
            <thead>
              <tr class="bg-slate-800 text-white">
                <th class="col-rank px-3 py-4 font-semibold uppercase text-xs">
                  Rank
                </th>
                <th
                  class="col-score px-3 py-4 font-semibold uppercase text-xs text-center"
                >
                  Puntaje
                </th>
                <th
                  class="col-authors px-3 py-4 font-semibold uppercase text-xs"
                >
                  Autores
                </th>
                <th class="col-title px-3 py-4 font-semibold uppercase text-xs">
                  T√≠tulo
                </th>
                <th
                  class="col-year px-3 py-4 font-semibold uppercase text-xs text-center"
                >
                  A√±o
                </th>
                <th
                  class="col-journal px-3 py-4 font-semibold uppercase text-xs"
                >
                  Revista / Fuente
                </th>
                <th
                  class="col-abstract px-3 py-4 font-semibold uppercase text-xs"
                >
                  Resumen
                </th>
                <th
                  class="col-keywords px-3 py-4 font-semibold uppercase text-xs"
                >
                  Palabras Claves
                </th>
                <th
                  class="col-lang px-3 py-4 font-semibold uppercase text-xs text-center"
                >
                  Idioma
                </th>
                <th
                  class="col-type px-3 py-4 font-semibold uppercase text-xs text-center"
                >
                  Tipo Doc.
                </th>
                <th
                  class="col-links px-3 py-4 font-semibold uppercase text-xs text-center"
                >
                  Enlaces
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200">
              <!-- Los datos se cargar√°n aqu√≠ -->
            </tbody>
          </table>
        </div>
        <div id="emptyState" class="p-20 text-center text-slate-400">
          <svg
            class="w-16 h-16 mx-auto mb-4 opacity-20"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            ></path>
          </svg>
          <p>
            Sube tu archivo (Scopus o Web of Science) para generar el ranking
            autom√°tico
          </p>
        </div>
      </div>
    </div>

    <script>
      let processedData = [];

      // Buscador seguro de columnas
      function getColumnValue(item, ...columnNames) {
        for (let colName of columnNames) {
          const key = Object.keys(item).find(
            (k) => k.trim().toLowerCase() === colName.toLowerCase(),
          );
          if (key && item[key] !== null && item[key] !== "") {
            return item[key];
          }
        }
        return "";
      }

      // --- DICCIONARIO DE TRADUCCI√ìN ---
      function translateData(text, type) {
        if (!text) return "N/D";
        const lower = text.toLowerCase().trim();

        if (type === "language") {
          if (lower.includes("english")) return "Ingl√©s";
          if (lower.includes("spanish")) return "Espa√±ol";
          if (lower.includes("portuguese")) return "Portugu√©s";
          if (lower.includes("french")) return "Franc√©s";
          if (lower.includes("german")) return "Alem√°n";
          if (lower.includes("chinese")) return "Chino";
          return text;
        }

        if (type === "document") {
          if (lower.includes("article") || lower === "art") return "Art√≠culo";
          if (lower.includes("review")) return "Revisi√≥n";
          if (
            lower.includes("conference paper") ||
            lower.includes("proceedings")
          )
            return "Art√≠culo de Conferencia";
          if (lower.includes("book chapter")) return "Cap√≠tulo de Libro";
          if (lower.includes("book")) return "Libro";
          if (lower.includes("editorial")) return "Editorial";
          if (lower.includes("letter")) return "Carta";
          if (lower.includes("note")) return "Nota";
          if (lower.includes("erratum")) return "Fe de Erratas";
          return text;
        }
        return text;
      }

      function processData() {
        const fileInput = document.getElementById("csvFile");
        const file = fileInput.files[0];

        if (!file) {
          alert("Por favor, selecciona un archivo (Excel o CSV) primero.");
          return;
        }

        const fileName = file.name.toLowerCase();

        if (fileName.endsWith(".csv")) {
          Papa.parse(file, {
            header: true,
            dynamicTyping: false,
            skipEmptyLines: true,
            quoteChar: '"',
            escapeChar: '"',
            complete: function (results) {
              analyzeData(results.data);
            },
          });
        } else if (fileName.endsWith(".xlsx") || fileName.endsWith(".xls")) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: "array" });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {
              defval: "",
            });
            analyzeData(jsonData);
          };
          reader.readAsArrayBuffer(file);
        } else {
          alert(
            "Formato no soportado. Por favor, sube un archivo .xlsx, .xls o .csv",
          );
        }
      }

      function analyzeData(rawData) {
        if (rawData.length === 0) {
          alert(
            "El archivo parece estar vac√≠o o no se pudo leer correctamente.",
          );
          return;
        }

        const keywords = {
          high: [
            "chatbot",
            "chatbots",
            "conversational agent",
            "intelligent assistant",
            "artificial intelligence",
            "ia",
            "ai",
            "llm",
            "virtual assistant",
            "generative ai",
          ],
          medium: [
            "web",
            "platform",
            "online",
            "internet",
            "website",
            "interface",
            "web-based",
          ],
          context: [
            "implementation",
            "strategy",
            "performance",
            "trends",
            "metrics",
            "desempe√±o",
            "estrategias",
            "tendencias",
            "evaluation",
            "framework",
          ],
        };

        processedData = rawData.map((item) => {
          let score = 0;

          // Extraer con sin√≥nimos (Scopus y WoS)
          const titleRaw = getColumnValue(
            item,
            "title",
            "article title",
          ).toString();
          const abstractRaw = getColumnValue(
            item,
            "abstract",
            "abstract text",
            "resumen",
          ).toString();
          const authKeywordsRaw = getColumnValue(
            item,
            "author keywords",
            "keywords",
            "keywords plus",
          ).toString();
          const sourceRaw = getColumnValue(
            item,
            "source title",
            "journal",
            "journal title",
          ).toString();

          const title = titleRaw.toLowerCase();
          const abstract = abstractRaw.toLowerCase();
          const fullText = `${title} ${abstract} ${authKeywordsRaw.toLowerCase()}`;

          let year = parseInt(getColumnValue(item, "year", "publication year"));
          if (isNaN(year)) year = 0;

          keywords.high.forEach((word) => {
            if (fullText.includes(word)) score += 25;
            if (title.includes(word)) score += 20;
          });
          keywords.medium.forEach((word) => {
            if (fullText.includes(word)) score += 15;
            if (title.includes(word)) score += 10;
          });
          keywords.context.forEach((word) => {
            if (fullText.includes(word)) score += 10;
            if (title.includes(word)) score += 10;
          });

          if (year >= 2021 && year <= 2025) {
            score += 100;
          } else if (year >= 2018) {
            score += 15;
          } else if (year > 0) {
            score -= 50;
          }

          const citedBy = parseInt(
            getColumnValue(
              item,
              "cited by",
              "times cited, wos core",
              "times cited, all databases",
            ),
          );
          if (!isNaN(citedBy)) {
            score += Math.min(citedBy / 2, 30);
          }

          return {
            ...item,
            _cleanTitle: titleRaw || "Sin t√≠tulo",
            _cleanYear: year,
            _cleanAuthors:
              getColumnValue(item, "authors", "author full names") ||
              "Sin autor",
            _cleanSource: sourceRaw || "N/D",
            _cleanAbstract: abstractRaw || "Sin resumen disponible.",
            _cleanKeywords: authKeywordsRaw || "N/D",
            _cleanLanguage: translateData(
              getColumnValue(
                item,
                "language of original document",
                "language",
                "idioma",
              ),
              "language",
            ),
            _cleanDocType: translateData(
              getColumnValue(
                item,
                "document type",
                "document type(s)",
                "tipo de documento",
              ),
              "document",
            ),
            _cleanLink: getColumnValue(item, "link", "doi link", "url") || "",
            _cleanDoi:
              getColumnValue(item, "doi", "digital object identifier") || "",
            relevanceScore: Math.round(score),
          };
        });

        processedData = processedData.filter(
          (d) => d._cleanTitle !== "Sin t√≠tulo",
        );
        processedData.sort((a, b) => b.relevanceScore - a.relevanceScore);

        renderTable();
        updateStats();
      }

      function renderTable() {
        const tbody = document.querySelector("#resultTable tbody");
        const emptyState = document.getElementById("emptyState");
        const downloadBtn = document.getElementById("downloadBtn");

        tbody.innerHTML = "";
        emptyState.classList.add("hidden");
        downloadBtn.classList.remove("hidden");

        processedData.forEach((item, index) => {
          const row = document.createElement("tr");
          row.className = "hover:bg-slate-50 transition-colors";

          const scoreColor =
            item.relevanceScore >= 130
              ? "bg-emerald-100 text-emerald-800"
              : item.relevanceScore >= 80
                ? "bg-blue-100 text-blue-800"
                : "bg-slate-100 text-slate-700";

          let linkHtml = `<div class="flex flex-col gap-1 items-center">`;
          if (item._cleanLink) {
            linkHtml += `<a href="${item._cleanLink}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline text-[11px] font-semibold bg-blue-50 px-2 py-1 rounded w-full text-center">üîó Link</a>`;
          }
          if (item._cleanDoi) {
            const isUrl = item._cleanDoi.toString().startsWith("http");
            const href = isUrl
              ? item._cleanDoi
              : `https://doi.org/${item._cleanDoi}`;
            linkHtml += `<a href="${href}" target="_blank" class="text-emerald-600 hover:text-emerald-800 hover:underline text-[11px] font-semibold bg-emerald-50 px-2 py-1 rounded w-full text-center">üìÑ DOI</a>`;
          }
          linkHtml += `</div>`;

          if (!item._cleanLink && !item._cleanDoi) {
            linkHtml = `<span class="text-slate-400 text-xs italic block text-center">N/A</span>`;
          }

          // Asegurar que el abstract y keywords sean strings y limpiar espacios extra
          const safeAbstract = (
            item._cleanAbstract || "Sin resumen disponible."
          )
            .replace(/\s+/g, " ")
            .trim();
          const safeKeywords = (item._cleanKeywords || "N/D")
            .replace(/\s+/g, " ")
            .trim();
          const safeAuthors = (item._cleanAuthors || "Sin autor")
            .replace(/\s+/g, " ")
            .trim();
          const safeJournal = (item._cleanSource || "N/D")
            .replace(/\s+/g, " ")
            .trim();

          row.innerHTML = `
                    <td class="px-3 py-4 text-sm font-bold text-slate-400 text-center">#${index + 1}</td>
                    <td class="px-3 py-4 text-center">
                        <span class="inline-block px-2 py-1 rounded text-xs font-bold ${scoreColor}">
                            ${item.relevanceScore} pts
                        </span>
                    </td>
                    <td class="px-3 py-4 text-xs text-slate-600">
                        <div class="truncate-multiline" style="-webkit-line-clamp: 3;" title="${safeAuthors}">${safeAuthors}</div>
                    </td>
                    <td class="px-3 py-4 text-sm font-semibold text-slate-800">
                        <div class="truncate-multiline truncate-title" title="${item._cleanTitle}">${item._cleanTitle}</div>
                    </td>
                    <td class="px-3 py-4 text-sm text-slate-600 font-bold text-center">${item._cleanYear > 0 ? item._cleanYear : "N/D"}</td>
                    <td class="px-3 py-4 text-xs font-medium text-slate-700">
                         <div class="truncate-multiline" style="-webkit-line-clamp: 2;" title="${safeJournal}">${safeJournal}</div>
                    </td>
                    <td class="px-3 py-4 text-xs text-slate-600 text-justify">
                        <div class="truncate-multiline truncate-abstract" title="${safeAbstract}">${safeAbstract}</div>
                    </td>
                    <td class="px-3 py-4 text-xs text-blue-700 font-medium">
                        <div class="truncate-multiline truncate-keywords" title="${safeKeywords}">${safeKeywords}</div>
                    </td>
                    <td class="px-3 py-4 text-xs text-slate-600 text-center">${item._cleanLanguage}</td>
                    <td class="px-3 py-4 text-xs text-slate-600 text-center">${item._cleanDocType}</td>
                    <td class="px-3 py-4">${linkHtml}</td>
                `;
          tbody.appendChild(row);
        });
      }

      function updateStats() {
        document.getElementById("statsContainer").classList.remove("hidden");
        document.getElementById("totalCount").innerText = processedData.length;
        document.getElementById("highRelCount").innerText =
          processedData.filter((d) => d.relevanceScore >= 130).length;
        document.getElementById("yearMatchCount").innerText =
          processedData.filter(
            (d) => d._cleanYear >= 2021 && d._cleanYear <= 2025,
          ).length;
      }

      function downloadResult() {
        if (processedData.length === 0) return;

        const exportData = processedData.map((item, idx) => {
          return {
            "Posici√≥n (Ranking)": idx + 1,
            "Puntaje de IA": item.relevanceScore,
            Autores: item._cleanAuthors,
            T√≠tulo: item._cleanTitle,
            A√±o: item._cleanYear > 0 ? item._cleanYear : "N/D",
            "Revista / Fuente": item._cleanSource,
            Resumen: item._cleanAbstract,
            "Palabras Clave": item._cleanKeywords,
            Idioma: item._cleanLanguage,
            "Tipo de Documento": item._cleanDocType,
            Enlace: item._cleanLink,
            DOI: item._cleanDoi,
          };
        });

        const worksheet = XLSX.utils.json_to_sheet(exportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Ranking");

        XLSX.writeFile(workbook, "Ranking_Traducido_Filtrado.xlsx");
      }
    </script>
  </body>
</html>
